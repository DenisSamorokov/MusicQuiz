<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - {{ t['Quisic'] }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v='3.0') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body class="relative flex flex-col min-h-screen">
    <!-- Анимированный фон -->
    <div class="animated-bg absolute inset-0 z-0"></div>
    <div class="container relative z-10 flex flex-col flex-1">
        <header class="header flex justify-between items-center mb-6 sm:mb-8">
            <div class="flex items-center">
                <button id="sidebar-toggle" class="sm:hidden text-gray-400 hover:text-gray-300 mr-4">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="{{ url_for('index') }}">
                    <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent">
                        <i class="fas fa-music mr-2"></i>{{ t['Quisic'] }}
                    </h1>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Переключатель языка -->
                <div class="relative">
                    <select id="language-select" class="filter-select text-sm sm:text-base">
                        <option value="ru" {% if get_locale() == 'ru' %}selected{% endif %}>🇷🇺 Русский</option>
                        <option value="en" {% if get_locale() == 'en' %}selected{% endif %}>🇬🇧 English</option>
                        <option value="es" {% if get_locale() == 'es' %}selected{% endif %}>🇪🇸 Español</option>
                        <option value="zh" {% if get_locale() == 'zh' %}selected{% endif %}>🇨🇳 中文</option>
                        <option value="ja" {% if get_locale() == 'ja' %}selected{% endif %}>🇯🇵 日本語</option>
                        <option value="pt" {% if get_locale() == 'pt' %}selected{% endif %}>🇵🇹 Português</option>
                        <option value="fr" {% if get_locale() == 'fr' %}selected{% endif %}>🇫🇷 Français</option>
                        <option value="de" {% if get_locale() == 'de' %}selected{% endif %}>🇩🇪 Deutsch</option>
                    </select>
                </div>
                {% if current_user.is_authenticated %}
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-200">{{ current_user.username }}</span>
                        <a href="{{ url_for('logout') }}" class="flex items-center space-x-1 text-red-400 hover:text-red-300 transition-colors duration-200">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>{{ t['Logout'] }}</span>
                        </a>
                    </div>
                {% else %}
                    <a href="{{ url_for('login') }}" class="text-blue-400 hover:text-blue-300 transition-colors duration-200">{{ t['Login'] }}</a>
                    <a href="{{ url_for('register') }}" class="text-blue-400 hover:text-blue-300 transition-colors duration-200">{{ t['Register'] }}</a>
                {% endif %}
            </div>
        </header>
        <div class="content-wrapper flex flex-col sm:flex-row sm:space-x-6 flex-1">
            <!-- Левая колонка: фильтры и чат -->
            <div class="sidebar sm:w-72 hidden sm:block animate-slide-in" id="sidebar">
                <!-- Фильтры -->
                <div class="block-background p-4 sm:p-6 mb-4 sm:mb-6 animate-slide-in">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-filter mr-2 text-blue-400"></i>{{ t['Filters'] }}
                    </h2>
                    <form id="filter-form" method="POST" action="/set_filter">
                        <div class="filter-group">
                            <label for="style-select" class="block mb-2 text-sm sm:text-base">{{ t['Genre'] }}</label>
                            <select id="style-select" name="style" class="filter-select w-full text-sm sm:text-base">
                                <option value="any" {% if session['selected_style'] == 'any' %}selected{% endif %}>{{ t['Any'] }}</option>
                                <option value="Pop" {% if session['selected_style'] == 'Pop' %}selected{% endif %}>{{ t['Pop'] }}</option>
                                <option value="Rock" {% if session['selected_style'] == 'Rock' %}selected{% endif %}>{{ t['Rock'] }}</option>
                                <option value="Rap_Hip Hop" {% if session['selected_style'] == 'Rap_Hip Hop' %}selected{% endif %}>{{ t['Rap_Hip Hop'] }}</option>
                                <option value="R_B" {% if session['selected_style'] == 'R_B' %}selected{% endif %}>{{ t['R_B'] }}</option>
                                <option value="Dance" {% if session['selected_style'] == 'Dance' %}selected{% endif %}>{{ t['Dance'] }}</option>
                                <option value="Electro" {% if session['selected_style'] == 'Electro' %}selected{% endif %}>{{ t['Electro'] }}</option>
                                <option value="Soul _ Funk" {% if session['selected_style'] == 'Soul _ Funk' %}selected{% endif %}>{{ t['Soul _ Funk'] }}</option>
                            </select>
                        </div>
                        <button type="submit" class="apply-btn w-full mt-2 text-sm sm:text-base">{{ t['Apply Filter'] }}</button>
                    </form>
                </div>
                <!-- Чат -->
                <div class="block-background p-4 sm:p-6 animate-slide-in" id="chat">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg sm:text-xl font-semibold flex items-center">
                            <a href="{{ url_for('chat') }}" class="flex items-center">
                                <i class="fas fa-comments mr-2 text-blue-400"></i>{{ t['Community Chat'] }}
                            </a>
                        </h2>
                        <button onclick="toggleChatFullscreen()" class="text-gray-400 hover:text-gray-300 transition-colors duration-200">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="space-y-3 mb-4 h-48 sm:h-64 overflow-y-auto" id="chat-messages-preview">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="p-2 bg-gray-700 rounded text-sm transition-transform duration-200 hover:scale-105">
                                    <span class="font-bold">{{ message.username }}:</span>
                                    <p class="text-sm text-gray-300">{{ message.message }}</p>
                                    <span class="text-xs text-gray-400">{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                            {% else %}
                                <p class="text-sm text-gray-400">{{ t['Chat is empty. Write the first message!'] }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% if current_user.is_authenticated %}
                        <form id="chat-form-preview" class="chat-input-form">
                            <input type="text" id="chat-input-preview" class="chat-input text-sm" placeholder="{{ t['Type a message...'] }}" required>
                            <button type="submit" class="chat-send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            <!-- Центральная часть: контент дочерних шаблонов -->
            <div class="main-content flex-1 max-w-full sm:max-w-2xl mb-4 sm:mb-0 animate-slide-in" id="main-content">
                {% block content %}{% endblock %}
            </div>
            <!-- Правая колонка: таблицы лидеров -->
            <div class="leaderboard-sidebar sm:w-72 hidden sm:block animate-slide-in" id="leaderboard-sidebar">
                <!-- Таблица лидеров за 24 часа -->
                {% if daily_leaders %}
                    <div class="block-background p-4 sm:p-6 mb-4 sm:mb-6 animate-slide-in" id="daily-leaderboard">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg sm:text-xl font-semibold flex items-center">
                                <i class="fas fa-trophy mr-2 text-blue-400"></i>{{ t['Top 24 Hours'] }}
                            </h2>
                            <button onclick="toggleLeaderboardFullscreen()" class="text-gray-400 hover:text-gray-300 transition-colors duration-200">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            {% set display_leaders = daily_leaders[:5] if not (current_user.is_authenticated and user_daily_rank is defined and user_daily_rank > 5) else daily_leaders[:4] + [{'username': current_user.username, 'total_score': current_user.score}] %}
                            {% for leader in display_leaders %}
                                {% set rank = loop.index if loop.index <= 5 and (not current_user.is_authenticated or leader.username != current_user.username) else user_daily_rank %}
                                <div class="flex items-center justify-between p-2 rounded text-sm sm:text-base transition-transform duration-200 hover:scale-105 {% if current_user.is_authenticated and leader.username == current_user.username %}bg-blue-600{% else %}bg-gray-700{% endif %}">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 {{ 'bg-yellow-500' if rank == 1 else 'bg-gray-500' if rank == 2 else 'bg-amber-800' if rank == 3 else 'bg-gray-700' }} rounded-full flex items-center justify-center text-xs font-bold mr-3">{{ rank }}</span>
                                        <span class="truncate">{{ leader.username }}</span>
                                    </div>
                                    <span class="font-bold">{{ leader.total_score }} {{ t['points'] }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                <!-- Общая таблица лидеров -->
                {% if leaders %}
                    <div class="block-background p-4 sm:p-6 mb-4 sm:mb-6 animate-slide-in" id="leaderboard">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg sm:text-xl font-semibold flex items-center">
                                <i class="fas fa-trophy mr-2 text-yellow-400"></i>{{ t['Leaderboard'] }}
                            </h2>
                            <button onclick="toggleLeaderboardFullscreen()" class="text-gray-400 hover:text-gray-300 transition-colors duration-200">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            {% set display_leaders = leaders[:5] if not (current_user.is_authenticated and user_overall_rank is defined and user_overall_rank > 5) else leaders[:4] + [{'username': current_user.username, 'score': current_user.score}] %}
                            {% for leader in display_leaders %}
                                {% set rank = loop.index if loop.index <= 5 and (not current_user.is_authenticated or leader.username != current_user.username) else user_overall_rank %}
                                <div class="flex items-center justify-between p-2 rounded text-sm sm:text-base transition-transform duration-200 hover:scale-105 {% if current_user.is_authenticated and leader.username == current_user.username %}bg-blue-600{% else %}bg-gray-700{% endif %}">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 {{ 'bg-yellow-500' if rank == 1 else 'bg-gray-500' if rank == 2 else 'bg-amber-800' if rank == 3 else 'bg-gray-700' }} rounded-full flex items-center justify-center text-xs font-bold mr-3">{{ rank }}</span>
                                        <span class="truncate">{{ leader.username }}</span>
                                    </div>
                                    <span class="font-bold">{{ leader.score }} {{ t['points'] }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Полноэкранный чат -->
        <div id="chat-fullscreen" class="chat-fullscreen hidden flex-col p-4">
            <div class="chat-fullscreen-header flex justify-between items-center mb-4">
                <button onclick="toggleChatFullscreen()" class="text-gray-400 hover:text-gray-300 transition-colors duration-200">
                    <i class="fas fa-arrow-left"></i> {{ t['Back'] }}
                </button>
                <h2 class="text-lg sm:text-xl font-semibold">{{ t['Community Chat'] }}</h2>
                <div></div>
            </div>
            <div class="chat-messages block-background p-4 rounded-lg flex-1 overflow-y-auto animate-slide-in" id="chat-messages-fullscreen">
                {% if messages %}
                    {% for message in messages %}
                        <div class="p-2 bg-gray-700 rounded mb-2 text-sm transition-transform duration-200 hover:scale-105">
                            <span class="font-bold">{{ message.username }}:</span>
                            <p class="text-sm text-gray-300">{{ message.message }}</p>
                            <span class="text-xs text-gray-400">{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            {% if current_user.is_authenticated %}
                <form id="chat-form-fullscreen" class="chat-input-form mt-4">
                    <input type="text" id="chat-input-fullscreen" class="chat-input text-sm" placeholder="{{ t['Type a message...'] }}" required>
                    <button type="submit" class="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            {% endif %}
        </div>
        <!-- Полноэкранная таблица лидеров -->
        <div id="leaderboard-fullscreen" class="leaderboard-fullscreen hidden p-4">
            <div class="flex justify-between items-center mb-4">
                <button onclick="toggleLeaderboardFullscreen()" class="text-gray-400 hover:text-gray-300 transition-colors duration-200">
                    <i class="fas fa-arrow-left"></i> {{ t['Back'] }}
                </button>
                <h2 class="text-lg sm:text-xl font-semibold">{{ t['Leaderboard'] }}</h2>
                <div></div>
            </div>
            <div class="block-background p-4 rounded-lg mb-4 animate-slide-in">
                <h3 class="text-base sm:text-lg font-semibold mb-4">{{ t['Top 24 Hours'] }}</h3>
                <div class="space-y-3">
                    {% if daily_leaders %}
                        {% set display_leaders = daily_leaders[:5] if not (current_user.is_authenticated and user_daily_rank is defined and user_daily_rank > 5) else daily_leaders[:4] + [{'username': current_user.username, 'total_score': current_user.score}] %}
                        {% for leader in display_leaders %}
                            {% set rank = loop.index if loop.index <= 5 and (not current_user.is_authenticated or leader.username != current_user.username) else user_daily_rank %}
                            <div class="flex items-center justify-between p-2 rounded text-sm transition-transform duration-200 hover:scale-105 {% if current_user.is_authenticated and leader.username == current_user.username %}bg-blue-600{% else %}bg-gray-700{% endif %}">
                                <div class="flex items-center">
                                    <span class="w-6 h-6 {{ 'bg-yellow-500' if rank == 1 else 'bg-gray-500' if rank == 2 else 'bg-amber-800' if rank == 3 else 'bg-gray-700' }} rounded-full flex items-center justify-center text-xs font-bold mr-3">{{ rank }}</span>
                                    <span class="truncate">{{ leader.username }}</span>
                                </div>
                                <span class="font-bold">{{ leader.total_score }} {{ t['points'] }}</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-gray-400">{{ t['No results for the last 24 hours'] }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="block-background p-4 rounded-lg animate-slide-in">
                <h3 class="text-base sm:text-lg font-semibold mb-4">{{ t['Overall Top'] }}</h3>
                <div class="space-y-3">
                    {% if leaders %}
                        {% set display_leaders = leaders[:5] if not (current_user.is_authenticated and user_overall_rank is defined and user_overall_rank > 5) else leaders[:4] + [{'username': current_user.username, 'score': current_user.score}] %}
                        {% for leader in display_leaders %}
                            {% set rank = loop.index if loop.index <= 5 and (not current_user.is_authenticated or leader.username != current_user.username) else user_overall_rank %}
                            <div class="flex items-center justify-between p-2 rounded text-sm transition-transform duration-200 hover:scale-105 {% if current_user.is_authenticated and leader.username == current_user.username %}bg-blue-600{% else %}bg-gray-700{% endif %}">
                                <div class="flex items-center">
                                    <span class="w-6 h-6 {{ 'bg-yellow-500' if rank == 1 else 'bg-gray-500' if rank == 2 else 'bg-amber-800' if rank == 3 else 'bg-gray-700' }} rounded-full flex items-center justify-center text-xs font-bold mr-3">{{ rank }}</span>
                                    <span class="truncate">{{ leader.username }}</span>
                                </div>
                                <span class="font-bold">{{ leader.score }} {{ t['points'] }}</span>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Футер -->
    <footer class="w-full py-4 text-center text-gray-400 text-sm bg-gray-900 z-10">
        <p>©2025 {{ t['Quisic'] }}. {{ t['All rights reserved.'] }}</p>
    </footer>

    <script>
        const socket = io();
        const translations = {{ t | tojson }};
        let isChatInitialized = false;

        function setupChatForm(formId, inputId, messagesId) {
            const chatForm = document.getElementById(formId);
            const chatInput = document.getElementById(inputId);
            const chatMessages = document.getElementById(messagesId);

            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            if (chatForm && chatInput) {
                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const message = chatInput.value.trim();
                    if (message) {
                        socket.emit('send_message', { message });
                        chatInput.value = '';
                    }
                });

                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                });
            }
        }

        function setupChatMessages(messagesId) {
            const chatMessages = document.getElementById(messagesId);
            if (chatMessages && !chatMessages.dataset.listenerAdded) {
                chatMessages.dataset.listenerAdded = 'true';
                socket.on('chat_message', (data) => {
                    if (chatMessages.offsetParent !== null) {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('p-2', 'bg-gray-700', 'rounded', 'mb-2', 'text-sm', 'transition-transform', 'duration-200', 'hover:scale-105');
                        messageElement.innerHTML = `
                            <span class="font-bold">${data.username}:</span>
                            <p class="text-sm text-gray-300">${data.message}</p>
                            <span class="text-xs text-gray-400">${new Date(data.timestamp).toLocaleString('{{ get_locale() }}-RU')}</span>
                        `;
                        chatMessages.appendChild(messageElement);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
            }
        }

        function initializeChat() {
            if (!isChatInitialized) {
                setupChatForm('chat-form-preview', 'chat-input-preview', 'chat-messages-preview');
                setupChatForm('chat-form-fullscreen', 'chat-input-fullscreen', 'chat-messages-fullscreen');
                setupChatMessages('chat-messages-preview');
                setupChatMessages('chat-messages-fullscreen');
                isChatInitialized = true;
            }
        }

        initializeChat();

        function toggleChatFullscreen() {
            const chatFullscreen = document.getElementById('chat-fullscreen');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const leaderboardSidebar = document.getElementById('leaderboard-sidebar');
            if (chatFullscreen.classList.contains('hidden')) {
                chatFullscreen.classList.remove('hidden');
                sidebar.classList.add('hidden');
                mainContent.classList.add('hidden');
                leaderboardSidebar.classList.add('hidden');
            } else {
                chatFullscreen.classList.add('hidden');
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('hidden');
                leaderboardSidebar.classList.remove('hidden');
            }
            const chatMessagesFullscreen = document.getElementById('chat-messages-fullscreen');
            if (chatMessagesFullscreen) {
                chatMessagesFullscreen.scrollTop = chatMessagesFullscreen.scrollHeight;
            }
        }

        function toggleLeaderboardFullscreen() {
            const leaderboardFullscreen = document.getElementById('leaderboard-fullscreen');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const leaderboardSidebar = document.getElementById('leaderboard-sidebar');
            if (leaderboardFullscreen.classList.contains('hidden')) {
                leaderboardFullscreen.classList.remove('hidden');
                sidebar.classList.add('hidden');
                mainContent.classList.add('hidden');
                leaderboardSidebar.classList.add('hidden');
            } else {
                leaderboardFullscreen.classList.add('hidden');
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('hidden');
                leaderboardSidebar.classList.remove('hidden');
            }
        }

        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const leaderboardSidebar = document.getElementById('leaderboard-sidebar');
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                leaderboardSidebar.classList.remove('hidden');
            } else {
                sidebar.classList.add('hidden');
                leaderboardSidebar.classList.add('hidden');
            }
        });

        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const style = document.getElementById('style-select').value || 'any';
            fetch('/set_filter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ style: style })
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      const currentPath = window.location.pathname;
                      const difficultyMatch = currentPath.match(/\/play\/(easy|medium|hard)/);
                      const difficulty = difficultyMatch ? difficultyMatch[1] : 'easy';
                      window.location.href = `/play/${difficulty}?style=${encodeURIComponent(data.style)}`;
                  }
              })
              .catch(error => console.error(translations['Filter error:'], error));
        });

        // Обработчик смены языка
        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
            languageSelect.addEventListener('change', () => {
                const lang = languageSelect.value;
                fetch('/set_language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: lang })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    }
                })
                .catch(error => console.error('Error changing language:', error));
            });
        }

        window.addEventListener('load', () => {
            const styleSelect = document.getElementById('style-select');
            styleSelect.value = '{{ session["selected_style"] or "any" }}';
        });
    </script>
</body>
</html>