{% extends "base.html" %}

{% block title %}Чат{% endblock %}

{% block content %}
<div class="chat-fullscreen flex flex-col p-4 sm:p-6">
    <div class="chat-fullscreen-header flex justify-between items-center mb-4">
        <a href="{{ url_for('index') }}" class="text-blue-400 hover:text-blue-300 transition-colors duration-200">
            <i class="fas fa-arrow-left mr-2"></i>Назад
        </a>
        <h2 class="text-lg sm:text-xl font-semibold">Чат сообщества</h2>
        <div></div>
    </div>
    <div class="chat-messages block-background p-4 rounded-lg flex-1 overflow-y-auto animate-slide-in" id="chat-messages">
        {% for message in messages %}
            <div class="p-2 bg-gray-700 rounded mb-2 text-sm transition-transform duration-200 hover:scale-105">
                <span class="font-bold">{{ message.username }}:</span>
                <p class="text-sm text-gray-300">{{ message.message }}</p>
                <span class="text-xs text-gray-400">{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
        {% endfor %}
    </div>
    {% if current_user.is_authenticated %}
        <form id="chat-form" class="chat-input-form mt-4">
            <input type="text" id="chat-input" class="chat-input text-sm" placeholder="Введите сообщение..." required>
            <button type="submit" class="chat-send-btn bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    {% endif %}
</div>

<script>
    const socket = io();
    setupChatForm('chat-form', 'chat-input', 'chat-messages');
    setupChatMessages('chat-messages');

    function setupChatForm(formId, inputId, messagesId) {
        const chatForm = document.getElementById(formId);
        const chatInput = document.getElementById(inputId);
        const chatMessages = document.getElementById(messagesId);

        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        if (chatForm && chatInput) {
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message) {
                    socket.emit('send_message', { message });
                    chatInput.value = '';
                }
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }
            });
        }
    }

    function setupChatMessages(messagesId) {
        const chatMessages = document.getElementById(messagesId);
        if (chatMessages) {
            socket.on('chat_message', (data) => {
                if (chatMessages.offsetParent !== null) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('p-2', 'bg-gray-700', 'rounded', 'mb-2', 'text-sm', 'transition-transform', 'duration-200', 'hover:scale-105');
                    messageElement.innerHTML = `
                        <span class="font-bold">${data.username}:</span>
                        <p class="text-sm text-gray-300">${data.message}</p>
                        <span class="text-xs text-gray-400">${new Date(data.timestamp).toLocaleString('ru-RU')}</span>
                    `;
                    chatMessages.appendChild(messageElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }
    }
</script>
{% endblock %}